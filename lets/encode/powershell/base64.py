from lets.__module__ import Module, Mount, Container
import base64


class Base64(Module):
    """
    Base64 encode a PowerShell script and wrap it in a decode stub.
    """
    
    def handle(self, input, url=None):
        assert input is not None, "Must provide powershell as input"

        for data in input:
            encoded = base64.b64encode(data).decode()
            
            cmd  =  "&([ScriptBlock]::Create("
            cmd +=      "[System.Text.Encoding]::Ascii.GetString("
            cmd +=          "[System.Convert]::FromBase64String("
            cmd +=              "'%s'" % encoded
            cmd +=          ")"
            cmd +=      ")"
            cmd +=  "))"

            yield cmd.encode()
